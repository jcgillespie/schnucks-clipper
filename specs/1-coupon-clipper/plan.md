# Implementation Plan: Schnucks Coupon Clipper

**Branch**: `1-coupon-clipper` | **Date**: 2026-01-16 | **Spec**: [spec.md](file:///Users/joshgillespie/src/schnucks-coupons/specs/1-coupon-clipper/spec.md)

## Summary

Build a lightweight Node.js/Playwright application to automatically clip all available Schnucks coupons using an existing authenticated session. The solution includes a Dockerized application with Alpine-based multi-stage build, Terraform infrastructure for Azure Container App Jobs with Azure File Share persistence, and GitHub Actions CI/CD pipelines. Tasks are ordered by dependency with infrastructure preceding deployment automation.

---

## Technical Context

| Aspect | Value |
|--------|-------|
| **Language/Version** | Node.js 20 LTS (Alpine) + TypeScript |
| **Primary Dependencies** | Playwright (Chromium), dotenv |
| **Storage** | Azure File Share mounted at `/home/playwright/data` |
| **Testing** | Node.js built-in test runner (`node --test`) |
| **Target Platform** | Azure Container App Jobs (Linux container) |
| **Project Type** | Single containerized application |
| **Performance Goals** | Complete all coupon clipping in < 5 minutes per run |
| **Constraints** | Azure Always Free tier, < 500MB container image |
| **Scale/Scope** | Single user, daily scheduled execution |

---

## Constitution Check

*GATE: Verified against [constitution.md](file:///Users/joshgillespie/src/schnucks-coupons/.specify/memory/constitution.md)*

| Principle | Status | Notes |
|-----------|--------|-------|
| **I. Code Quality First** | ✅ PASS | TypeScript strict mode, ESLint/Prettier, explicit error handling |
| **II. Simplicity Over Cleverness** | ✅ PASS | Single-purpose CLI, flat project structure, minimal dependencies |
| **III. Maintainability by Design** | ✅ PASS | README quickstart, actionable error messages, graceful degradation |

---

## Project Structure

### Documentation (this feature)

```text
specs/1-coupon-clipper/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Technology research
├── data-model.md        # Data entities
├── quickstart.md        # Developer setup guide
├── contracts/           # API contract definitions
│   └── schnucks-api.yaml
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── index.ts             # Entry point - CLI runner
├── clipper.ts           # Core coupon clipping logic
├── session.ts           # Session management (load/save context)
├── api.ts               # Schnucks API client wrapper
├── config.ts            # Configuration from environment
└── logger.ts            # Structured logging utility

tests/
├── unit/
│   ├── clipper.test.ts
│   ├── session.test.ts
│   └── api.test.ts
└── integration/
    └── clipper.integration.test.ts

infra/
├── main.tf              # Main Terraform configuration
├── variables.tf         # Input variables
├── outputs.tf           # Output values
├── providers.tf         # Azure provider config
└── modules/
    ├── storage/         # Azure File Share module
    │   ├── main.tf
    │   ├── variables.tf
    │   └── outputs.tf
    └── container-job/   # Container App Job module
        ├── main.tf
        ├── variables.tf
        └── outputs.tf

.github/
└── workflows/
    ├── ci.yaml          # Build and test on PR
    ├── cd.yaml          # Deploy on merge to main
    └── terraform.yaml   # Infrastructure validation

Dockerfile               # Multi-stage Alpine build
.dockerignore
package.json
tsconfig.json
.eslintrc.json
.prettierrc
README.md
```

**Structure Decision**: Single project layout with separate `src/`, `tests/`, and `infra/` directories. This aligns with the constitution's simplicity principle while maintaining clear separation of concerns.

---

## Component Groups (Dependency Order)

> [!IMPORTANT]
> Tasks are ordered by dependency. Each group must be completed before the next can begin.

### Group 1: Environment Setup

Foundation files required before any implementation.

| File | Description |
|------|-------------|
| [package.json](file:///Users/joshgillespie/src/schnucks-coupons/package.json) | Node.js project with TypeScript, Playwright, ESLint, Prettier |
| [tsconfig.json](file:///Users/joshgillespie/src/schnucks-coupons/tsconfig.json) | TypeScript strict mode configuration |
| [.eslintrc.json](file:///Users/joshgillespie/src/schnucks-coupons/.eslintrc.json) | Linting rules per constitution |
| [.prettierrc](file:///Users/joshgillespie/src/schnucks-coupons/.prettierrc) | Code formatting configuration |
| [.env.example](file:///Users/joshgillespie/src/schnucks-coupons/.env.example) | Environment variable template |
| [.dockerignore](file:///Users/joshgillespie/src/schnucks-coupons/.dockerignore) | Docker build exclusions |

---

### Group 2: Application Logic

Core Node.js/Playwright application (depends on Group 1).

#### [NEW] [config.ts](file:///Users/joshgillespie/src/schnucks-coupons/src/config.ts)
- Load environment variables with validation
- Export typed configuration object
- Fail fast on missing required config

#### [NEW] [logger.ts](file:///Users/joshgillespie/src/schnucks-coupons/src/logger.ts)
- Structured JSON logging for container environments
- Log levels: debug, info, warn, error
- Include timestamp, operation context

#### [NEW] [session.ts](file:///Users/joshgillespie/src/schnucks-coupons/src/session.ts)
- `loadContext(path: string)`: Load Playwright browser context from disk
- `saveContext(context, path: string)`: Persist context to disk
- Detect invalid/expired sessions and throw descriptive errors

#### [NEW] [api.ts](file:///Users/joshgillespie/src/schnucks-coupons/src/api.ts)
- `getCoupons(context)`: GET `api/coupon-api/v1/coupons` using session headers/cookies
- `clipCoupon(context, couponId)`: POST `api/coupon-api/v1/clipped`
- Handle rate limiting with exponential backoff
- Parse and validate API responses

#### [NEW] [clipper.ts](file:///Users/joshgillespie/src/schnucks-coupons/src/clipper.ts)
- `clipAllCoupons()`: Main orchestration function
- Filter `availableCoupons` array from API response
- Iterate and clip each coupon with logging
- Return summary: clipped count, skipped count, errors

#### [NEW] [index.ts](file:///Users/joshgillespie/src/schnucks-coupons/src/index.ts)
- Parse CLI arguments
- Initialize Playwright with persistent context
- Call `clipAllCoupons()` and handle exit codes
- Graceful error handling with actionable messages

#### Unit Tests

| Test File | Coverage |
|-----------|----------|
| [clipper.test.ts](file:///Users/joshgillespie/src/schnucks-coupons/tests/unit/clipper.test.ts) | clipAllCoupons logic with mocked API |
| [session.test.ts](file:///Users/joshgillespie/src/schnucks-coupons/tests/unit/session.test.ts) | Context load/save, error detection |
| [api.test.ts](file:///Users/joshgillespie/src/schnucks-coupons/tests/unit/api.test.ts) | API response parsing, retry logic |

---

### Group 3: Dockerfile

Container image (depends on Group 2 for build context).

#### [NEW] [Dockerfile](file:///Users/joshgillespie/src/schnucks-coupons/Dockerfile)

Multi-stage Alpine build:

```dockerfile
# Stage 1: Build
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json tsconfig.json ./
RUN npm ci
COPY src/ ./src/
RUN npm run build

# Stage 2: Runtime
FROM mcr.microsoft.com/playwright:v1.40.0-focal AS runtime
# Install only Chromium dependencies for minimal size
WORKDIR /home/playwright
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY package.json ./

# Create data directory for session persistence
RUN mkdir -p /home/playwright/data && chown -R pwuser:pwuser /home/playwright
USER pwuser
VOLUME ["/home/playwright/data"]

ENTRYPOINT ["node", "dist/index.js"]
```

> [!NOTE]
> Uses official Playwright Docker image as runtime base to ensure browser compatibility. Alpine used only in build stage.

---

### Group 4: Terraform Modules

Infrastructure as Code (can be developed in parallel with Group 2, but must deploy before Group 5).

#### Module: Storage

##### [NEW] [infra/modules/storage/main.tf](file:///Users/joshgillespie/src/schnucks-coupons/infra/modules/storage/main.tf)
- Azure Storage Account (Standard_LRS, free tier eligible)
- Azure File Share for session data
- Output connection string and share name

##### [NEW] [infra/modules/storage/variables.tf](file:///Users/joshgillespie/src/schnucks-coupons/infra/modules/storage/variables.tf)
- `resource_group_name`, `location`, `storage_account_name`, `file_share_name`

##### [NEW] [infra/modules/storage/outputs.tf](file:///Users/joshgillespie/src/schnucks-coupons/infra/modules/storage/outputs.tf)
- `storage_account_name`, `file_share_name`, `primary_access_key`

---

#### Module: Container Job

##### [NEW] [infra/modules/container-job/main.tf](file:///Users/joshgillespie/src/schnucks-coupons/infra/modules/container-job/main.tf)
- Azure Container App Environment
- Azure Container App Job (scheduled trigger)
- Mount Azure File Share to `/home/playwright/data`
- Configure image pull from registry

##### [NEW] [infra/modules/container-job/variables.tf](file:///Users/joshgillespie/src/schnucks-coupons/infra/modules/container-job/variables.tf)
- `resource_group_name`, `location`, `job_name`, `container_image`
- `schedule_cron`, `storage_account_name`, `file_share_name`, `storage_access_key`

##### [NEW] [infra/modules/container-job/outputs.tf](file:///Users/joshgillespie/src/schnucks-coupons/infra/modules/container-job/outputs.tf)
- `container_app_job_id`, `container_app_environment_id`

---

#### Root Terraform Configuration

##### [NEW] [infra/providers.tf](file:///Users/joshgillespie/src/schnucks-coupons/infra/providers.tf)
- Azure provider with required version
- Backend configuration for state storage

##### [NEW] [infra/variables.tf](file:///Users/joshgillespie/src/schnucks-coupons/infra/variables.tf)
- `subscription_id`, `resource_group_name`, `location`
- `container_image`, `schedule_cron`

##### [NEW] [infra/main.tf](file:///Users/joshgillespie/src/schnucks-coupons/infra/main.tf)
- Resource group
- Call storage module
- Call container-job module with storage outputs

##### [NEW] [infra/outputs.tf](file:///Users/joshgillespie/src/schnucks-coupons/infra/outputs.tf)
- `resource_group_name`, `container_job_name`, `file_share_url`

---

### Group 5: GitHub Workflows

CI/CD pipelines (depends on Groups 2-4 for build/deploy targets).

#### [NEW] [.github/workflows/ci.yaml](file:///Users/joshgillespie/src/schnucks-coupons/.github/workflows/ci.yaml)

Triggered on pull requests:
- Checkout code
- Setup Node.js 20
- Install dependencies
- Run linting (`npm run lint`)
- Run type checking (`npm run typecheck`)
- Run unit tests (`npm test`)
- Build Docker image (no push)

#### [NEW] [.github/workflows/terraform.yaml](file:///Users/joshgillespie/src/schnucks-coupons/.github/workflows/terraform.yaml)

Triggered on changes to `infra/`:
- Setup Terraform
- Run `terraform init`
- Run `terraform validate`
- Run `terraform plan` (on PR)
- Comment plan output on PR

#### [NEW] [.github/workflows/cd.yaml](file:///Users/joshgillespie/src/schnucks-coupons/.github/workflows/cd.yaml)

Triggered on merge to main:
- Build and push Docker image to GitHub Container Registry
- Run `terraform apply -auto-approve`
- Update Container App Job with new image tag
- Post deployment status

**Required Secrets**:
- `AZURE_CREDENTIALS` (Service Principal JSON)
- `AZURE_SUBSCRIPTION_ID`
- `GHCR_TOKEN` (GitHub Container Registry)

---

## Verification Plan

### Automated Tests

| Test Type | Command | Description |
|-----------|---------|-------------|
| **Unit Tests** | `npm test` | Run all unit tests in `tests/unit/` |
| **Lint** | `npm run lint` | ESLint validation |
| **Type Check** | `npm run typecheck` | TypeScript compilation check |
| **Docker Build** | `docker build -t schnucks-clipper:test .` | Verify image builds successfully |
| **Terraform Validate** | `cd infra && terraform validate` | Validate Terraform syntax |
| **Terraform Plan** | `cd infra && terraform plan` | Preview infrastructure changes |

### Manual Verification

> [!CAUTION]
> Manual session setup requires access to a valid Schnucks account.

1. **Local Run Test**:
   - Create `.env` with required variables
   - Run `npx playwright install chromium`
   - Execute `npm run dev` and verify coupon clipping output
   - Check `/home/playwright/data` for persisted session

2. **Container Test**:
   - Build: `docker build -t schnucks-clipper:test .`
   - Run: `docker run -v $(pwd)/data:/home/playwright/data schnucks-clipper:test`
   - Verify session persistence in `./data`

3. **Azure Deployment Test**:
   - Apply Terraform: `cd infra && terraform apply`
   - Manually trigger Container App Job in Azure Portal
   - Check job logs for successful execution
   - Verify File Share contains session data

---

## Complexity Tracking

No constitution violations. All design decisions align with core principles:

- **Minimal dependencies**: Only Playwright (required), dotenv (standard)
- **Flat structure**: Single `src/` directory with 6 files
- **Explicit configuration**: All settings via environment variables

name: Terraform

on:
  pull_request:
    paths:
      - 'infra/**'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to use for plan'
        required: true
        default: 'latest'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  TF_LOG: INFO
  # OpenTofu uses the same environment variables as Terraform for the most part
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  TFSTATE_RESOURCE_GROUP: ${{ secrets.TFSTATE_RESOURCE_GROUP }}
  TFSTATE_STORAGE_ACCOUNT: ${{ secrets.TFSTATE_STORAGE_ACCOUNT }}
  TFSTATE_CONTAINER: ${{ secrets.TFSTATE_CONTAINER }}
  TFSTATE_KEY: ${{ secrets.TFSTATE_KEY }}

jobs:
  terraform-plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infra

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0

      - name: OpenTofu Init
        # For PRs (especially external forks), secrets may not be available.
        # Format and validate don't require backend state, so use -backend=false.
        # For workflow_dispatch or when secrets are available, use backend config.
        run: |
          if [ -n "$TFSTATE_RESOURCE_GROUP" ] && [ -n "$TFSTATE_STORAGE_ACCOUNT" ] && [ -n "$TFSTATE_CONTAINER" ] && [ -n "$TFSTATE_KEY" ]; then
            tofu init \
              -backend-config="resource_group_name=${TFSTATE_RESOURCE_GROUP}" \
              -backend-config="storage_account_name=${TFSTATE_STORAGE_ACCOUNT}" \
              -backend-config="container_name=${TFSTATE_CONTAINER}" \
              -backend-config="key=${TFSTATE_KEY}"
          else
            echo "Backend secrets not available, initializing without backend (format/validate only)"
            tofu init -backend=false
          fi

      - name: OpenTofu Format
        run: tofu fmt -check

      - name: OpenTofu Validate
        run: tofu validate

      - name: OpenTofu Plan
        # Plan requires backend state, so only run if backend was initialized
        run: |
          if [ -n "$TFSTATE_RESOURCE_GROUP" ] && [ -n "$TFSTATE_STORAGE_ACCOUNT" ] && [ -n "$TFSTATE_CONTAINER" ] && [ -n "$TFSTATE_KEY" ]; then
            tofu plan -no-color \
              -var "image_name=ghcr.io/${{ github.repository }}:${{ github.event.inputs.image_tag || 'latest' }}" \
              -var "registry_username=${{ github.actor }}" \
              -var "registry_password=${{ secrets.GHCR_PAT }}" \
              -var "action_group_email=${{ secrets.ACTION_GROUP_EMAIL }}"
          else
            echo "Skipping plan: Backend secrets not available (this is expected for external PRs)"
          fi
        continue-on-error: true
